# Django Telegram Admin Login Notifier

## Описание задачи

Этот проект реализует Django-приложение и Telegram-бота, которые уведомляют всех подписанных пользователей Telegram о каждом успешном входе любого пользователя в админку Django. В уведомлении указывается дата входа и имя пользователя.

---

## Стек технологий
- Python 3.8+
- Django 4.x
- pyTelegramBotAPI
- pytest / unittest

---

## Реализация

### 1. Django-приложение
- Приложение `notifier` добавлено в проект.
- Модель `Subscriber` хранит chat_id, nickname и дату подписки пользователя Telegram.
- В админке Django (`/admin`) можно просматривать, искать и сортировать подписчиков.

### 2. Telegram-бот
- Бот реализован на pyTelegramBotAPI (`bot.py`).
- Команда `/start` сохраняет пользователя в подписчики (по chat_id и username Telegram). Если пользователь уже есть — обновляет никнейм.
- Команда `/stop` удаляет пользователя из подписчиков.

### 3. Отправка уведомлений
- Используется сигнал Django `user_logged_in`.
- При каждом успешном входе в админку (`/admin`) вызывается функция, которая отправляет всем подписчикам сообщение вида:
  > Дата входа: 2025-05-06 14:30:20\nИмя пользователя: admin
- Для отправки сообщений используется отдельный модуль `notifier/telegram_notify.py`.
- Все ошибки отправки логируются через стандартный logging.

### 4. Тестирование
- Покрытие unit-тестами: создание/удаление подписчиков, массовая рассылка сообщений.
- Тесты расположены в `notifier/tests.py`, используются unittest и mock.

---

## Асинхронная отправка уведомлений (Celery)

- Все уведомления о входе в админку отправляются подписчикам **асинхронно** через очередь задач Celery и брокер Redis.
- Это гарантирует, что вход в админку не блокируется рассылкой, а сообщения отправляются быстро и надёжно.
- Можно масштабировать celery worker для высокой нагрузки.

---

## Дополнительные возможности админки

- Экспорт подписчиков в CSV прямо из Django admin (выдели нужных и выбери действие "Экспортировать выбранных подписчиков в CSV").
- Фильтрация подписчиков по дате подписки.
- Удобный поиск и сортировка по chat_id и nickname.

---

## Быстрый старт

### 1. Клонирование репозитория
```bash
git clone <URL>
cd <project_folder>
```

### 2. Настройка переменных окружения
1. Скопируйте пример:
   ```bash
   cp .env.example .env
   ```
2. Отредактируйте `.env` при необходимости (укажите токен Telegram, параметры БД).

### 3. Запуск через Docker Compose
```bash
docker-compose up --build
```
- Django будет доступен на http://localhost:8000
- PostgreSQL на порту 5432 (локально)
- Бот стартует как отдельный сервис

### 4. Остановка контейнеров
```bash
docker-compose down
```

### 5. Тесты (в контейнере web)
```bash
docker-compose exec web python manage.py test notifier
```

---

## Пример .env
```
POSTGRES_DB=admin_notifier
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_HOST=db
POSTGRES_PORT=5432
TELEGRAM_BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11

DJANGO_SECRET_KEY=тут ключик джанги
DJANGO_SETTINGS_MODULE=admin_notifier.settings
DEBUGMODE=True
```

---

## Как это работает
1. Любой пользователь пишет боту `/start` — его id и username сохраняются в базе.
2. При каждом успешном входе в Django admin срабатывает сигнал, который вызывает функцию рассылки.
3. Всем подписчикам отправляется сообщение с датой и именем вошедшего пользователя.
4. Пользователь может отписаться командой `/stop`.
5. В админке Django можно просматривать и искать подписчиков.

---

## Структура проекта
```
admin_notifier/         # Django-проект
notifier/               # Django-приложение
    models.py           # Модель подписчика
    admin.py            # Отображение в админке
    telegram_notify.py  # Массовая рассылка
    signals.py          # Сигналы входа в админку
    tests.py            # Тесты
bot.py                  # Telegram-бот
requirements.txt
README.md
```

---

## Важно
- Для работы бота необходим валидный токен Telegram.
- Для production рекомендуется вынести токен и другие секреты в переменные окружения.
- Все критичные ошибки при рассылке логируются.

---

## Авторизация в админке
- Создайте суперпользователя:
  ```bash
  python3 manage.py createsuperuser
  ```
- Перейдите на `/admin` и войдите — подписчики получат уведомление.

---

## Связь и поддержка
Если возникли вопросы по коду или запуску — пишите!
